#!/bin/bash
# Run ansible packages playbook to install user packages
# This runs after dotfiles are deployed

set -euo pipefail

CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
PLAYBOOKS_DIR="${CHEZMOI_SOURCE}/.chezmoiplaybooks"
INSTALL_MODE="{{ .installMode }}"

#############################################
# Load package manager environments
# This is needed on first run before dotfiles
# have been sourced by a new shell
#############################################
load_package_manager_envs() {
  # Add ~/.local/bin to PATH (for mise, ansible, etc.)
  export PATH="${HOME}/.local/bin:${PATH}"

  # Nix
  if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi

  # Homebrew (macOS ARM64)
  if [ -d /opt/homebrew ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  # Homebrew (macOS Intel)
  elif [ -d /usr/local/Homebrew ]; then
    eval "$(/usr/local/bin/brew shellenv)"
  # Linuxbrew
  elif [ -d /home/linuxbrew/.linuxbrew ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  fi

  # Mise
  if [ -f "${HOME}/.local/bin/mise" ]; then
    eval "$("${HOME}/.local/bin/mise" activate bash)"
  fi

  # Devbox (uses nix, so load after nix)
  if command -v devbox &>/dev/null; then
    eval "$(devbox global shellenv)"
  fi
}

#############################################
# Run Ansible packages playbook
#############################################
run_playbook() {
  printf '[PACKAGES] Running packages playbook (mode: %s)\n' "$INSTALL_MODE"
  
  cd "${PLAYBOOKS_DIR}"
  
  # No sudo needed - packages.yml only installs user-level packages:
  # - Homebrew packages/bundle (runs as user)
  # - Nix/home-manager (runs as user)
  # - Mise tools (runs as user)
  # Native packages and GUI apps requiring sudo are now in site.yml (bootstrap)
  ansible-playbook playbooks/packages.yml -e "install_mode=${INSTALL_MODE}"
}

#############################################
# Main
#############################################
load_package_manager_envs
run_playbook

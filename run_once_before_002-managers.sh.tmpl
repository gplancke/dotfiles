#!/bin/bash
# Run ansible bootstrap playbook to install package managers and tools

set -euo pipefail

CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
PLAYBOOKS_DIR="${CHEZMOI_SOURCE}/.chezmoiplaybooks"
INSTALL_MODE="{{ .installMode }}"

export PATH="${HOME}/.local/bin:${PATH}"

# macOS system Python uses ~/Library/Python/X.Y/bin, Linux uses ~/.local/bin
if command -v python3 >/dev/null 2>&1; then
  PYTHON_USER_BIN="$(python3 -c 'import sysconfig; print(sysconfig.get_path("scripts", "posix_user"))')"
  export PATH="${PYTHON_USER_BIN}:${HOME}/.local/bin:${PATH}"
fi

#############################################
# Verify Ansible is available
# Bootstrap should have installed it
#############################################
verify_ansible() {
  if ! command -v ansible-playbook >/dev/null 2>&1; then
    printf '[MANAGERS] ERROR: ansible-playbook not found in PATH.\n'
    printf '[MANAGERS] Bootstrap may have failed. Please re-run: chezmoi apply\n'
    exit 1
  fi

  if ! command -v ansible-galaxy >/dev/null 2>&1; then
    printf '[MANAGERS] ERROR: ansible-galaxy not found in PATH.\n'
    printf '[MANAGERS] Bootstrap may have failed. Please re-run: chezmoi apply\n'
    exit 1
  fi
}

#############################################
# Run Ansible playbook
#############################################
run_playbook() {
  printf '[MANAGERS] Installing package managers (mode: %s)\n' "$INSTALL_MODE"

  cd "${PLAYBOOKS_DIR}"

  # Set feature flags based on install mode
  # Use -K to ask for sudo password upfront (site.yml requires sudo for system setup)
  case "$INSTALL_MODE" in
    container)
      # Minimal install for containers
      ansible-playbook -K playbooks/site.yml \
        -e "install_docker=false" \
        -e "install_nix=false" \
        -e "install_devbox=false"
      ;;
    server)
      # Server install (no desktop apps)
      ansible-playbook -K playbooks/site.yml \
        -e "install_desktop_apps=false"
      ;;
    desktop)
      # Full desktop install
      ansible-playbook -K playbooks/site.yml \
        -e "install_desktop_apps=true"
      ;;
    *)
      # Default to server mode
      ansible-playbook -K playbooks/site.yml
      ;;
  esac
}

verify_ansible
run_playbook

#!/bin/bash

# Best practices: exit on error, undefined vars, and pipe failures
set -euo pipefail

# Optional: uncomment for debugging
# set -x

{{/* Include shared utility functions */}}
{{- template "shell-utils" . -}}

{{ if eq .chezmoi.os "darwin" -}}
DISTRO="darwin"
{{- else -}}
# Detect Linux distribution
if [ -f /etc/os-release ]; then
  . /etc/os-release
  case "$ID" in
    fedora|rhel|centos|rocky|almalinux)
      DISTRO="fedora"
      ;;
    arch|manjaro|endeavouros|garuda)
      DISTRO="arch"
      ;;
    ubuntu|debian|pop|elementary|linuxmint)
      DISTRO="debian"
      ;;
    alpine)
      DISTRO="alpine"
      ;;
    *)
      DISTRO="unknown"
      ;;
  esac
else
  DISTRO="unknown"
fi
{{- end }}

main() {
	case "$DISTRO" in
		"darwin")
			load_env "darwin"
			setup_ttyd "launchctl"
			;;
		"debian")
			load_env "debian"
			setup_ttyd "systemd"
			;;
		"fedora")
			load_env "fedora"
			setup_ttyd "systemd"
			;;
		"arch")
			load_env "arch"
			setup_ttyd "systemd"
			;;
		"alpine")
			load_env "alpine"
			setup_ttyd "openrc"
			;;
		*)
			echo "Unsupported distribution: $DISTRO" >&2
			exit 1
			;;
	esac
}

main "$@"

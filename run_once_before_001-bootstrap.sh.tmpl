#!/bin/bash
# Bootstrap script - runs once before first chezmoi apply
# - Creates essential directories
# - Installs Ansible
# - Installs Ansible Galaxy
# - Installs Ansible collections

set -euo pipefail

{{ if eq .chezmoi.os "darwin" -}}
DISTRO="darwin"
{{- else -}}
# Detect Linux distribution
if [ -f /etc/os-release ]; then
  . /etc/os-release
  case "$ID" in
    fedora|rhel|centos|rocky|almalinux)
      DISTRO="fedora"
      ;;
    arch|manjaro|endeavouros|garuda|cachyos)
      DISTRO="arch"
      ;;
    ubuntu|debian|pop|elementary|linuxmint)
      DISTRO="debian"
      ;;
    alpine)
      DISTRO="alpine"
      ;;
    *)
      DISTRO="unknown"
      ;;
  esac
else
  DISTRO="unknown"
fi
{{- end }}

CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
PLAYBOOKS_DIR="${CHEZMOI_SOURCE}/.chezmoiplaybooks"

#############################################
# Create minimal directory structure
#############################################
setup_directories() {
  mkdir -p "${HOME}/.local/bin"
  mkdir -p "${HOME}/.local/share"
}

#############################################
# Install Ansible
#############################################
install_ansible() {
  local distro=$1

  if command -v ansible-playbook >/dev/null 2>&1; then
    return 0
  fi

  printf '[BOOTSTRAP] Installing Ansible...'

  case "$distro" in
    debian)
      sudo apt-get update -qq
      sudo apt-get install -qq -y python3 python3-pip python3-venv >/dev/null
      python3 -m pip install --user --break-system-packages -q ansible 2>/dev/null || \
        python3 -m pip install --user -q ansible
      ;;
    fedora)
      sudo dnf install -q -y python3 python3-pip >/dev/null
      python3 -m pip install --user -q ansible
      ;;
    arch)
      sudo pacman -Syu --noconfirm -q >/dev/null 2>&1
      sudo pacman -S --noconfirm -q python python-pip ansible >/dev/null 2>&1
      ;;
    alpine)
      sudo apk update -q
      sudo apk add -q python3 py3-pip ansible
      ;;
    darwin)
      # Check for Xcode CLI tools first
      if ! xcode-select -p &>/dev/null; then
        printf '\n[BOOTSTRAP] Installing Xcode Command Line Tools...\n'
        xcode-select --install 2>/dev/null || true
        printf '\n*** Please complete Xcode CLI tools installation and re-run: chezmoi apply ***\n'
        exit 1
      fi
      python3 -m pip install --user --break-system-packages -q ansible 2>/dev/null || \
        python3 -m pip install --user -q ansible
      # macOS system Python installs to ~/Library/Python/X.Y/bin, not ~/.local/bin
      PYTHON_USER_BIN="$(python3 -c 'import sysconfig; print(sysconfig.get_path("scripts", "posix_user"))')"
      export PATH="${PYTHON_USER_BIN}:${PATH}"
      ;;
    *)
      printf '\n[BOOTSTRAP] Error: unsupported distribution "%s"\n' "$distro"
      return 1
      ;;
  esac

  # Add ~/.local/bin to PATH for this session (Linux distros use this path)
  export PATH="${HOME}/.local/bin:${PATH}"
  printf ' done\n'
}

#############################################
# Install Ansible collections
#############################################
install_ansible_collections() {
  export PATH="${HOME}/.local/bin:${PATH}"

  # macOS system Python uses ~/Library/Python/X.Y/bin, Linux uses ~/.local/bin
  if command -v python3 >/dev/null 2>&1; then
    PYTHON_USER_BIN="$(python3 -c 'import sysconfig; print(sysconfig.get_path("scripts", "posix_user"))')"
    export PATH="${PYTHON_USER_BIN}:${HOME}/.local/bin:${PATH}"
  fi

  # Verify ansible-galaxy is available
  if ! command -v ansible-galaxy >/dev/null 2>&1; then
    printf '[BOOTSTRAP] Warning: ansible-galaxy not found in PATH\n'
    return 1
  fi

  if [ -f "${PLAYBOOKS_DIR}/requirements.yml" ]; then
    printf '[BOOTSTRAP] Installing Ansible collections...'
    ansible-galaxy collection install -r "${PLAYBOOKS_DIR}/requirements.yml" >/dev/null 2>&1
    printf ' done\n'
  fi
}

#############################################
# Main
#############################################
main() {
  setup_directories
  install_ansible "$DISTRO"
  install_ansible_collections
}

main "$@"

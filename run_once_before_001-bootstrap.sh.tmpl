#!/bin/bash
# Bootstrap script - runs once before first chezmoi apply
# - Creates essential directories
# - Installs Ansible
# - Installs Ansible collections

set -euo pipefail

{{ if eq .chezmoi.os "darwin" -}}
DISTRO="darwin"
{{- else -}}
# Detect Linux distribution
if [ -f /etc/os-release ]; then
  . /etc/os-release
  case "$ID" in
    fedora|rhel|centos|rocky|almalinux)
      DISTRO="fedora"
      ;;
    arch|manjaro|endeavouros|garuda|cachyos)
      DISTRO="arch"
      ;;
    ubuntu|debian|pop|elementary|linuxmint)
      DISTRO="debian"
      ;;
    alpine)
      DISTRO="alpine"
      ;;
    *)
      DISTRO="unknown"
      ;;
  esac
else
  DISTRO="unknown"
fi
{{- end }}

CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
PLAYBOOKS_DIR="${CHEZMOI_SOURCE}/.chezmoiplaybooks"

#############################################
# Create minimal directory structure
#############################################
setup_directories() {
  printf '[BOOTSTRAP] Creating essential directories\n'
  mkdir -p "${HOME}/.local/bin"
  mkdir -p "${HOME}/.local/share"
}

#############################################
# Install Ansible
#############################################
install_ansible() {
  printf '[BOOTSTRAP] Installing Ansible\n'
  local distro=$1

  if command -v ansible-playbook >/dev/null 2>&1; then
    printf '...Ansible already installed\n'
    return 0
  fi

  case "$distro" in
    debian)
      printf '...Installing Ansible on Debian/Ubuntu\n'
      sudo apt-get update -y
      sudo apt-get install -y python3 python3-pip python3-venv
      python3 -m pip install --user --break-system-packages ansible 2>/dev/null || \
        python3 -m pip install --user ansible
      ;;
    fedora)
      printf '...Installing Ansible on Fedora/RHEL\n'
      sudo dnf install -y python3 python3-pip
      python3 -m pip install --user ansible
      ;;
    arch)
      printf '...Installing Ansible on Arch\n'
      sudo pacman -Syu --noconfirm
      sudo pacman -S --noconfirm python python-pip ansible
      ;;
    alpine)
      printf '...Installing Ansible on Alpine\n'
      sudo apk update
      sudo apk add python3 py3-pip ansible
      ;;
    darwin)
      # Check for Xcode CLI tools first
      if ! xcode-select -p &>/dev/null; then
        printf '...Installing Xcode Command Line Tools...\n'
        xcode-select --install 2>/dev/null || true
        printf '\n*** Please complete Xcode CLI tools installation and re-run: chezmoi apply ***\n'
        exit 1
      fi
      printf '...Installing Ansible on macOS\n'
      python3 -m pip install --user --break-system-packages ansible 2>/dev/null || \
        python3 -m pip install --user ansible
      ;;
    *)
      printf '...Error: unsupported distribution "%s"\n' "$distro"
      return 1
      ;;
  esac

  # Add ~/.local/bin to PATH for this session
  export PATH="${HOME}/.local/bin:${PATH}"
}

#############################################
# Install Ansible collections
#############################################
install_ansible_collections() {
  printf '[BOOTSTRAP] Installing Ansible collections\n'
  
  # Ensure PATH includes pip install location
  export PATH="${HOME}/.local/bin:${PATH}"
  
  # Verify ansible-galaxy is available
  if ! command -v ansible-galaxy >/dev/null 2>&1; then
    printf '...Warning: ansible-galaxy not found in PATH\n'
    printf '...PATH is: %s\n' "$PATH"
    return 1
  fi
  
  if [ -f "${PLAYBOOKS_DIR}/requirements.yml" ]; then
    ansible-galaxy collection install -r "${PLAYBOOKS_DIR}/requirements.yml"
  fi
}

#############################################
# Main
#############################################
main() {
  setup_directories
  install_ansible "$DISTRO"
  install_ansible_collections
  
  printf '[BOOTSTRAP] Bootstrap complete. Ansible is ready.\n'
}

main "$@"

#!/bin/bash
# Run ansible bootstrap playbook to install package managers and tools

set -euo pipefail

CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
PLAYBOOKS_DIR="${CHEZMOI_SOURCE}/.chezmoiplaybooks"
INSTALL_MODE="{{ .installMode }}"

# Ensure PATH includes ansible location
export PATH="${HOME}/.local/bin:${PATH}"

#############################################
# Run Ansible playbook
#############################################
run_playbook() {
  printf '[MANAGERS] Running bootstrap playbook (mode: %s)\n' "$INSTALL_MODE"
  
  cd "${PLAYBOOKS_DIR}"
  
  # Set feature flags based on install mode
  case "$INSTALL_MODE" in
    container)
      # Minimal install for containers
      ansible-playbook playbooks/site.yml \
        -e "install_docker=false" \
        -e "install_nix=false" \
        -e "install_devbox=false"
      ;;
    server)
      # Server install (no desktop apps)
      ansible-playbook playbooks/site.yml \
        -e "install_desktop_apps=false"
      ;;
    desktop)
      # Full desktop install
      ansible-playbook playbooks/site.yml \
        -e "install_desktop_apps=true"
      ;;
    *)
      # Default to server mode
      ansible-playbook playbooks/site.yml
      ;;
  esac
}

run_playbook

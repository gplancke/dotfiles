#!/bin/bash

set -euo pipefail

# Optional: uncomment for debugging
# set -x

{{/* Include shared utility functions */}}
{{- template "shell-utils" . -}}

{{ if eq .chezmoi.os "darwin" -}}
DISTRO="darwin"
{{- else -}}
# Detect Linux distribution
if [ -f /etc/os-release ]; then
  . /etc/os-release
  case "$ID" in
    fedora|rhel|centos|rocky|almalinux)
      DISTRO="fedora"
      ;;
    arch|manjaro|endeavouros|garuda)
      DISTRO="arch"
      ;;
    ubuntu|debian|pop|elementary|linuxmint)
      DISTRO="debian"
      ;;
    alpine)
      DISTRO="alpine"
      ;;
    *)
      DISTRO="unknown"
      ;;
  esac
else
  DISTRO="unknown"
fi
{{- end }}

#############################################
# Install essential tooling
#############################################

install_essentials() {
  local distro=$1
  local home="$HOME"
  local local_dir="$home/.local"
  local workspace="$home/Workspace/Projects"

  git_disable_ssl "$distro"

  # Create required directories
  mkdir -p \
    "$local_dir"/{bin,share,etc,src} \
    "$local_dir/share"/{node_modules,python_packages,gems,pnpm} \
    "$workspace"

  case "$distro" in
    debian)
      printf 'Updating APT and installing essentials...\n'
      sudo apt-get update -y && sudo apt-get upgrade -y
      sudo apt-get install -y \
        build-essential curl git zsh fonts-hack-ttf
      ;;
    fedora)
      printf 'Updating DNF and installing essentials...\n'
      sudo dnf update -y
      sudo dnf install -y \
        @development-tools curl git zsh hack-fonts
      ;;
    arch)
      printf 'Updating Pacman and installing essentials...\n'
      sudo pacman -Syu --noconfirm
      sudo pacman -S --noconfirm \
        base-devel curl git zsh ttf-hack
      ;;
    alpine)
      printf 'Updating APK and installing essentials...\n'
      sudo apk update && sudo apk upgrade
      sudo apk add \
        build-base curl git zsh font-hack-ttf
      ;;
    darwin)
      printf 'Installing essentials for macos...\n'
      xcode-select --install || true
      install_brew "darwin"
      if command -v brew >/dev/null 2>&1; then
        brew install --quiet openssl curl git zsh font-hack-nerd-font
      fi
      ;;
    *)
      printf 'Error: unsupported distribution "%s"\n' "$distro"
      return 1
      ;;
  esac

  git_enable_ssl

  printf 'Done. Please log out and back in for changes to take effect.\n'
}

#############################################
# Install Docker engine and CLI
# Ensures daemon is enabled and user is in docker group
#############################################

install_docker() {
  local distro=$1

	if command -v docker >/dev/null 2>&1; then
		# printf 'Docker is already installed.\n'
		return 0
	fi

  case "$distro" in
    debian|fedora)
      printf 'Installing Docker using the official convenience script...\n'
      curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
      sh /tmp/get-docker.sh

      sudo systemctl enable docker || true
      sudo systemctl start docker || true

      sudo groupadd docker 2>/dev/null || true
      sudo usermod -aG docker "$USER" || true
      ;;
    arch)
      printf 'Installing Docker on Arch-based systems...\n'
      sudo pacman -Syu --noconfirm
      sudo pacman -S --noconfirm docker docker-compose || true

      sudo systemctl enable docker || true
      sudo systemctl start docker || true

      sudo groupadd docker 2>/dev/null || true
      sudo usermod -aG docker "$USER" || true
      ;;
    alpine)
      printf 'Installing Docker on Alpine Linux...\n'
      sudo apk add docker docker-compose || true

      sudo rc-update add docker default || true
      sudo service docker start || true

      addgroup "$USER" docker || true
      ;;
    darwin)
      printf 'Installing Docker Desktop and CLI on macOS...\n'
      install_brew "darwin"
      if command -v brew >/dev/null 2>&1; then
        brew install --quiet docker || true
				brew install --quiet docker-compose || true
				brew install --quiet docker-buildx || true
        brew install --quiet colima || true
      fi
      ;;
    *)
      printf 'Skipping Docker: unsupported distribution "%s"\n' "$distro"
      ;;
  esac

  printf 'Docker installation step complete. You may need to log out/in for group changes to apply.\n'
}

#############################################
# Installs homebrew on darwin and linux
# On linux it installs linuxbrew
# We tend to use nix instead
#############################################

install_brew() {
  local os_type="$1"
  local installer_url="https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh"
  local brew_bin

  # If brew already exists, bail out
  if command -v brew >/dev/null 2>&1; then
    # printf 'Homebrew is already installed (%s)\n' "$(command -v brew)"
    return 0
  fi

  printf 'Installing Homebrew...\n'
  /bin/bash -c "$(curl -fsSL $installer_url)"

  # Determine where brew was installed
  if [ "$os_type" = "darwin" ]; then
    brew_bin="/opt/homebrew/bin/brew"
  else
    if [ -d "/home/linuxbrew/.linuxbrew" ]; then
      brew_bin="/home/linuxbrew/.linuxbrew/bin/brew"
    else
      brew_bin="$HOME/.linuxbrew/bin/brew"
    fi
  fi

  load_brew "$os_type"

  if command -v brew >/dev/null 2>&1; then
    printf 'Homebrew installed and initialized: %s\n' "$(command -v brew)"
  else
    printf 'Error: brew not found after installation\n' >&2
    return 1
  fi
}

#############################################
# Install nix on darwin and linux
# On darwin, we add the nix-darwin util
#############################################

install_nix() {
  local os_type=$1
  local nix_profile="$HOME/.nix-profile"
  local installer_url="https://install.determinate.systems/nix"
  local uninstall_script="$HOME/.local/bin/nix-uninstall"

  # If Nix isn't already installedâ€¦
  if ! command -v nix >/dev/null 2>&1; then
    printf 'Installing Nix via %s\n' "$installer_url"
		[ "$os_type" = "darwin" ] && sudo ln -sf /etc/ssl/cert.pem /etc/ssl/certs/ca-certificates.crt
    curl --proto '=https' --tlsv1.2 -sSfL "$installer_url" | sh -s -- install --determinate --no-confirm
  else
    printf 'Nix is already installed at %s\n' "$nix_profile"
  fi
}

install_homemanager() {
  load_nix
	printf 'Installing Home Manager...\n'
}

install_devbox() {
	if ! command -v devbox >/dev/null 2>&1; then
		curl -fsSL https://get.jetify.com/devbox | bash
	fi
}

#############################################
# Install complement tooling
#############################################

install_complements() {
  local distro=$1

  git_disable_ssl "$distro"

  case "$distro" in
    debian)
      printf 'No additional complements needed for Debian-based systems...\n'
      ;;
    fedora)
      printf 'No additional complements needed for Fedora-based systems...\n'
      ;;
    arch)
      printf 'No additional complements needed for Arch-based systems...\n'
      ;;
    alpine)
      printf 'No additional complements needed for Alpine Linux...\n'
      ;;
    darwin)
      printf 'Installing complements via Homebrew...\n'
      ;;
    *)
      printf 'Error: unsupported distribution "%s"\n' "$distro"
      return 1
      ;;
  esac

  git_enable_ssl

  printf 'Done. Please log out and back in for changes to take effect.\n'
}

#############################################
# Install them all
#############################################
install_essentials $DISTRO
install_docker $DISTRO
install_brew $DISTRO

install_nix $DISTRO
install_homemanager $DISTRO
install_devbox $DISTRO

install_complements $DISTRO

exit 0

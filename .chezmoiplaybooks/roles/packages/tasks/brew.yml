---
# Homebrew package installation

- name: Set Homebrew paths based on OS
  ansible.builtin.set_fact:
    homebrew_prefix: "{{ '/opt/homebrew' if ansible_facts['os_family'] == 'Darwin' and ansible_facts['architecture'] == 'arm64' else '/usr/local' if ansible_facts['os_family'] == 'Darwin' else '/home/linuxbrew/.linuxbrew' }}"

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: "{{ homebrew_prefix }}/bin/brew"
  register: homebrew_check

- name: Install Homebrew packages
  community.general.homebrew:
    name: "{{ brew_packages }}"
    state: present
    path: "{{ homebrew_prefix }}/bin"
  when:
    - homebrew_check.stat.exists
    - brew_packages is defined
    - brew_packages | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Install Homebrew casks (macOS only)
  community.general.homebrew_cask:
    name: "{{ brew_casks }}"
    state: present
    path: "{{ homebrew_prefix }}/bin"
  when:
    - homebrew_check.stat.exists
    - ansible_facts['os_family'] == 'Darwin'
    - brew_casks is defined
    - brew_casks | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Install from Brewfile.common (cross-platform)
  ansible.builtin.shell:
    cmd: "{{ homebrew_prefix }}/bin/brew bundle --file={{ brewfile_common }}"
  args:
    executable: /bin/bash
  when:
    - homebrew_check.stat.exists
    - brewfile_common is defined
    - brewfile_common | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  register: brew_bundle_common
  changed_when: "'Installing' in brew_bundle_common.stdout or 'Upgrading' in brew_bundle_common.stdout"

- name: Install from Brewfile.darwin (macOS-only)
  ansible.builtin.shell:
    cmd: "{{ homebrew_prefix }}/bin/brew bundle --file={{ brewfile_darwin }}"
  args:
    executable: /bin/bash
  when:
    - homebrew_check.stat.exists
    - ansible_facts['os_family'] == 'Darwin'
    - brewfile_darwin is defined
    - brewfile_darwin | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  register: brew_bundle_darwin
  changed_when: "'Installing' in brew_bundle_darwin.stdout or 'Upgrading' in brew_bundle_darwin.stdout"

- name: Install from Brewfile.linux (Linux-only)
  ansible.builtin.shell:
    cmd: "{{ homebrew_prefix }}/bin/brew bundle --file={{ brewfile_linux }}"
  args:
    executable: /bin/bash
  when:
    - homebrew_check.stat.exists
    - ansible_facts['os_family'] != 'Darwin'
    - brewfile_linux is defined
    - brewfile_linux | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  register: brew_bundle_linux
  changed_when: "'Installing' in brew_bundle_linux.stdout or 'Upgrading' in brew_bundle_linux.stdout"

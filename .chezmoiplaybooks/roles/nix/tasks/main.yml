---
# Nix role - Install Nix package manager using Determinate Systems installer

- name: Check if Nix is already installed
  ansible.builtin.stat:
    path: /nix
  register: nix_check

- name: Install Nix
  when: not nix_check.stat.exists
  block:
    - name: Download Determinate Nix installer
      ansible.builtin.get_url:
        url: https://install.determinate.systems/nix
        dest: /tmp/nix-installer.sh
        mode: "0755"

    - name: Run Nix installer
      become: true
      ansible.builtin.command:
        # --volume-encrypt=false: Skip Nix volume encryption on macOS since FileVault already encrypts the disk
        cmd: /tmp/nix-installer.sh install --no-confirm {{ '--volume-encrypt=false' if ansible_os_family == 'Darwin' else '' }}
      environment:
        NIX_INSTALLER_NO_CONFIRM: "true"
      register: nix_install

    - name: Clean up installer
      ansible.builtin.file:
        path: /tmp/nix-installer.sh
        state: absent

- name: Verify Nix installation
  become: true
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi
      nix --version
  args:
    executable: /bin/bash
  register: nix_version
  changed_when: false
  failed_when: false

- name: Display Nix status
  ansible.builtin.debug:
    msg: "{{ 'Nix installed: ' + nix_version.stdout if nix_version.rc == 0 else 'Nix installation pending shell restart' }}"
